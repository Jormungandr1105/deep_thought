#!/bin/bash
################################################################################
##   RUNS COMMANDS ACRPSS MULTIPLE NODES   #####################################
################################################################################

################################################################################
##   FUNCTIONS   ###############################################################
################################################################################

function exec_command() {
	command=$1
	location=$2
	sep="################################################################################\n##  $location\n################################################################################\n"
	sep2="\n################################################################################"
	if [[ "$location" == "$HOSTNAME" ]]; then
		echo -e "$sep$($command)$sep2" | tee -a "log.txt" > /dev/null &
	else
		echo -e "$sep$(ssh "$location" -tt "$command && exit")$sep2" | tee -a "log.txt" > /dev/null &
	fi
}

################################################################################
##   MAIN   ####################################################################
################################################################################

command=$1
hostfile=$2
hosts=(`cat "$hostfile"`)

if [[ -e "log.txt" ]]; then
	rm "log.txt"
fi

for i in "${hosts[@]}"; do
	exec_command "$command" "$i"
done
wait
