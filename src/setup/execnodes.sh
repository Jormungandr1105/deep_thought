#!/bin/bash
################################################################################
##   RUNS COMMANDS ACROSS MULTIPLE NODES   #####################################
################################################################################

################################################################################
##   FUNCTIONS   ###############################################################
################################################################################

function exec_command() {
	command=$1
	location=$2
	sep="################################################################################\n##  $location\n################################################################################\n"
	sep2="\n################################################################################"
	if [[ "$location" == "$HOSTNAME" ]]; then
		cd ~
		echo -e "$sep$($command)$sep2" | tee -a "$log" > /dev/null &
	else
		echo -e "$sep$(ssh "$location" -tt "$command && exit")$sep2" | tee -a "$log" > /dev/null &
		echo > /dev/null
	fi
}

################################################################################
##   MAIN   ####################################################################
################################################################################

command=$1
hostfile=$2
hosts=(`cat "$hostfile"`)
log="$(pwd)/log.txt"

if [[ -e "$log" ]]; then
	rm "$log"
fi

touch "$log"

for i in "${hosts[@]}"; do
	exec_command "$command" "$i"
done
wait
